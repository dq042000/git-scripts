#!/bin/bash

# ç”¨æ–¼ Copilot ç¨‹å¼ç¢¼å¯©æŸ¥çš„ pre-commit é‰¤å­
# æ­¤è…³æœ¬æœƒåœ¨ commit å‰å¯©æŸ¥å·²æš«å­˜çš„è®Šæ›´

# è¨­å®šåƒæ•¸
MAX_DIFF_LINES=500
MAX_FILES=20
REVIEW_PROMPT="è«‹æ‰®æ¼”è³‡æ·±é–‹ç™¼äººå“¡ï¼Œé‡å°ä»¥ä¸‹ç¨‹å¼ç¢¼è®Šæ›´é€²è¡Œ Code Reviewã€‚è«‹æ¶µè“‹ï¼š1. æ‰¾å‡ºæ½›åœ¨ Bugã€‚2. æä¾›æ•ˆèƒ½å„ªåŒ–å»ºè­°ã€‚3. å»ºè­°æ›´ä¹¾æ·¨çš„ç¨‹å¼ç¢¼çµæ§‹æˆ–å‘½åæ–¹å¼ã€‚4. æª¢æŸ¥æ˜¯å¦æœ‰å®‰å…¨é¢¨éšªã€‚è«‹ä½¿ç”¨å°ç£ç¹é«”ä¸­æ–‡å›ç­”ï¼Œå…§å®¹è¦ç²¾ç°¡ä¸”å…·é«”ã€‚"
SENSITIVE_PATTERNS="password|passwd|secret|key|token|api[_-]?key|private[_-]?key|secret[_-]?key|access[_-]?token"

# é€€å‡ºå‡½æ•¸
exit_with_message() {
    echo "$1"
    exit "${2:-0}"
}

# çµ±ä¸€çš„ç”¨æˆ¶ç¢ºèªå‡½æ•¸
ask_user_confirmation() {
    local prompt="$1"
    local default="${2:-N}"  # é è¨­å€¼ï¼šY æˆ– N
    local user_input
    
    if [[ $default == "Y" ]]; then
        echo -n "$prompt (Y/n): "
    else
        echo -n "$prompt (y/N): "
    fi
    
    read -r user_input < /dev/tty
    
    if [[ $default == "Y" ]]; then
        [[ ! $user_input =~ ^[Nn]$ ]]
    else
        [[ $user_input =~ ^[Yy]$ ]]
    fi
}

# æ•æ„Ÿè³‡è¨Šæª¢æŸ¥å‡½æ•¸
check_sensitive_data() {
    local diff_content="$1"
    
    if echo "$diff_content" | grep -qiE "\+.*($SENSITIVE_PATTERNS)"; then
        echo "âš ï¸  åµæ¸¬åˆ°å¯èƒ½åŒ…å«æ•æ„Ÿè³‡è¨Šï¼Œè«‹ç¢ºèªå¾Œå†ç¹¼çºŒ"
        echo "    è­¦å‘Šï¼šç¨‹å¼ç¢¼å¯©æŸ¥æœƒå°‡å…§å®¹å‚³é€è‡³ GitHub Copilot"
        if ! ask_user_confirmation "ç¢ºå®šè¦ç¹¼çºŒå¯©æŸ¥ï¼Ÿ" "N"; then
            exit_with_message "âŒ ä½¿ç”¨è€…å–æ¶ˆå¯©æŸ¥" 1
        fi
    fi
}

# Fail-safe è·³è„«æ©Ÿåˆ¶
emergency_exit() {
    echo ""
    echo "ğŸš¨ ç·Šæ€¥è·³è„«ï¼šæŒ‰ Ctrl+C å¾Œè¼¸å…¥ 'skip' å¯å¼·åˆ¶è·³éå¯©æŸ¥"
    if ask_user_confirmation "å¼·åˆ¶è·³éæ‰€æœ‰æª¢æŸ¥ä¸¦ç¹¼çºŒ commitï¼Ÿ" "N"; then
        exit_with_message "âš ï¸  å·²å¼·åˆ¶è·³éå¯©æŸ¥" 0
    fi
}

# è¨­å®š Ctrl+C è™•ç†
trap emergency_exit INT

# æª¢æŸ¥æ˜¯å¦æœ‰å·²æš«å­˜çš„æª”æ¡ˆéœ€è¦å¯©æŸ¥
if git diff --cached --quiet; then
    exit_with_message "æ²’æœ‰å·²æš«å­˜çš„è®Šæ›´éœ€è¦å¯©æŸ¥ã€‚"
fi

# æª¢æŸ¥æ˜¯å¦æœ‰å®‰è£ copilot
if ! command -v copilot &> /dev/null; then
    echo "âš ï¸  æœªåµæ¸¬åˆ° GitHub Copilot CLI"
    if ask_user_confirmation "æ˜¯å¦è¦è·³éå¯©æŸ¥ä¸¦ç¹¼çºŒ commitï¼Ÿ" "Y"; then
        exit_with_message "âœ… è·³éå¯©æŸ¥ï¼Œç¹¼çºŒ commit"
    else
        exit_with_message "âŒ Commit å·²å–æ¶ˆ" 1
    fi
fi

echo "æ­£åœ¨å¯©æŸ¥æš«å­˜çš„ç¨‹å¼ç¢¼è®Šæ›´..."
echo "========================================"

# è©¢å•æ˜¯å¦è¦é€²è¡Œå¯©æŸ¥
if ! ask_user_confirmation "æ˜¯å¦è¦åŸ·è¡Œ Copilot ç¨‹å¼ç¢¼å¯©æŸ¥ï¼Ÿ" "Y"; then
    exit_with_message "âœ… è·³éå¯©æŸ¥ï¼Œç›´æ¥ commit"
fi

# å…ˆæª¢æŸ¥è®Šæ›´çš„æª”æ¡ˆæ•¸é‡å’Œé¡å‹
CHANGED_FILES=$(git diff --cached --name-only)
FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)

echo "æª¢æ¸¬åˆ° $FILE_COUNT å€‹è®Šæ›´æª”æ¡ˆ"

# éæ¿¾ç¨‹å¼ç¢¼æª”æ¡ˆ
CODE_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(js|ts|jsx|tsx|py|go|java|cpp|c|h|php|rb|rs|sh|bash|yml|yaml|json|xml)$' || true)

if [ -z "$CODE_FILES" ]; then
    echo "âš ï¸  æœªæª¢æ¸¬åˆ°ç¨‹å¼ç¢¼æª”æ¡ˆè®Šæ›´"
    if ask_user_confirmation "æ˜¯å¦ä»è¦é€²è¡Œå¯©æŸ¥ï¼Ÿ" "N"; then
        STAGED_DIFF=$(git diff --cached)
    else
        exit_with_message "âœ… è·³éå¯©æŸ¥ï¼Œç¹¼çºŒ commit"
    fi
else
    echo "æª¢æ¸¬åˆ°ä»¥ä¸‹ç¨‹å¼ç¢¼æª”æ¡ˆï¼š"
    echo "$CODE_FILES"
    STAGED_DIFF=$(git diff --cached -- $CODE_FILES)
fi

# æª¢æŸ¥æ˜¯å¦æœ‰å¯¦éš›å…§å®¹éœ€è¦å¯©æŸ¥
if [ -z "$STAGED_DIFF" ]; then
    exit_with_message "æ²’æœ‰æª¢æ¸¬åˆ°ç¨‹å¼ç¢¼è®Šæ›´å…§å®¹ã€‚"
fi

# è¨ˆç®—è®Šæ›´è¡Œæ•¸
DIFF_LINES=$(echo "$STAGED_DIFF" | wc -l)
echo "ç¨‹å¼ç¢¼è®Šæ›´å…± $DIFF_LINES è¡Œ"

# æª¢æŸ¥æª”æ¡ˆæ•¸é‡é™åˆ¶
if [ "$FILE_COUNT" -gt "$MAX_FILES" ]; then
    echo "âš ï¸  è®Šæ›´æª”æ¡ˆæ•¸é‡éå¤š ($FILE_COUNT > $MAX_FILES)"
    if ! ask_user_confirmation "æ˜¯å¦ä»è¦é€²è¡Œå¯©æŸ¥ï¼Ÿ" "N"; then
        exit_with_message "âœ… è·³éå¯©æŸ¥ï¼Œç¹¼çºŒ commit"
    fi
fi

# æª¢æŸ¥ diff å¤§å°æ˜¯å¦è¶…éé™åˆ¶
if [ "$DIFF_LINES" -gt "$MAX_DIFF_LINES" ]; then
    echo "âš ï¸  è®Šæ›´å…§å®¹éå¤§ ($DIFF_LINES è¡Œ > $MAX_DIFF_LINES è¡Œé™åˆ¶)"
    if ! ask_user_confirmation "æ˜¯å¦ä»è¦é€²è¡Œå¯©æŸ¥ï¼Ÿ" "N"; then
        exit_with_message "âœ… è·³éå¯©æŸ¥ï¼Œç¹¼çºŒ commit"
    fi
fi

# æª¢æŸ¥æ•æ„Ÿè³‡è¨Š
check_sensitive_data "$STAGED_DIFF"

echo "æ­£åœ¨é€²è¡Œç¨‹å¼ç¢¼å¯©æŸ¥..."

# åŸ·è¡Œ copilot å¯©æŸ¥
copilot --prompt "$REVIEW_PROMPT

ä»¥ä¸‹æ˜¯ç¨‹å¼ç¢¼è®Šæ›´ï¼š

\`\`\`diff
$STAGED_DIFF
\`\`\`" --model gpt-4.1 --yolo

# æª¢æŸ¥ copilot æŒ‡ä»¤æ˜¯å¦åŸ·è¡ŒæˆåŠŸ
if [ $? -ne 0 ]; then
    echo "âŒ Copilot å¯©æŸ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–å‘½ä»¤è¨­å®š"
    if ask_user_confirmation "å¯©æŸ¥å¤±æ•—ï¼Œæ˜¯å¦è¦è·³éå¯©æŸ¥ä¸¦ç¹¼çºŒ commitï¼Ÿ" "N"; then
        exit_with_message "âœ… è·³éå¯©æŸ¥ï¼Œç¹¼çºŒ commit"
    else
        exit_with_message "âŒ Commit å·²å–æ¶ˆ" 1
    fi
fi

echo ""
echo "========================================"

if ask_user_confirmation "æ˜¯å¦è¦ç¹¼çºŒ commitï¼Ÿ" "N"; then
    exit_with_message "âœ… ç¹¼çºŒ commit..."
else
    exit_with_message "âŒ Commit å·²å–æ¶ˆ" 1
fi